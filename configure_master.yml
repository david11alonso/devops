---
- hosts: masters
  become: true
  tasks:
    - name: Initialize Kubernetes cluster
      shell: kubeadm init --pod-network-cidr=192.168.0.0/16
      ignore_errors: true

    - name: Set up kubeconfig for root user
      shell: |
        mkdir -p $HOME/.kube && \
        cp -f /etc/kubernetes/admin.conf $HOME/.kube/config && \
        chown $(id -u):$(id -g) $HOME/.kube/config

    - name: Install Flannel network plugin
      shell: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

    - name: Generate kubeadm join command
      shell: kubeadm token create --print-join-command
      register: kubeadm_join_command

    - name: Save join command to file
      copy:
        content: "{{ kubeadm_join_command.stdout }}"
        dest: /tmp/kubeadm_join_command.txt
